@inject IDialogService DialogService;

<MudCard>
    <MudCardHeader>
        <CardHeaderContent>
            <MudText Typo="Typo.h6">
                Gioco in corso
            </MudText>
        </CardHeaderContent>
    </MudCardHeader>
    <MudCardContent>
        <MudStack>
            <Hint InitialLimits="InitialLimits" MatchLimits="MatchLimits" />

            <PlayerTurn Player="Player" />

            <MudNumericField @ref="_betField"
                             Required="true"
                             Label="Scommetti"
                             HelperText="@($"Scegli un numero tra {MatchLimits.Min} e {MatchLimits.Max}")"
                             Min="MatchLimits.Min"
                             Max="MatchLimits.Max"
                             @bind-Value=_bet
                             OnKeyUp="OnKeyUp" />
        </MudStack>
    </MudCardContent>
    <MudCardActions>
        <MudStack Row="true">
            <MudButton Variant="Variant.Filled"
                       Color="@Color.Primary"
                       StartIcon="@Icons.Material.Filled.Send"
                       OnClick="Bet">
                Scommetti
            </MudButton>
            <MudButton Variant="Variant.Filled"
                       Color="@Color.Error"
                       StartIcon="@Icons.Material.Filled.DeleteForever"
                       OnClick="ConfirmSurrender">
                Abbandona
            </MudButton>
        </MudStack>
    </MudCardActions>
</MudCard>

@code {
    [Parameter]
    public Player? Player { get; set; }

    [Parameter, EditorRequired]
    public required Limits InitialLimits { get; set; }

    [Parameter, EditorRequired]
    public required Limits MatchLimits { get; set; }

    [Parameter, EditorRequired]
    public required Func<int, bool> CheckFunc { get; set; }

    [Parameter, EditorRequired]
    public EventCallback<int> OnContinue { get; set; }

    [Parameter, EditorRequired]
    public EventCallback<Player?> OnEnd { get; set; }

    private int _bet;

    private MudNumericField<int>? _betField;

    private async Task OnKeyUp(KeyboardEventArgs args)
    {
        if (args.Key == "Enter") await Bet();
    }

    private async Task Bet()
    {
        var lost = CheckFunc.Invoke(_bet);
        if (lost)
        {
            await OnEnd.InvokeAsync(Player);
        }
        else
        {
            await _betField!.SelectAsync();
            await OnContinue.InvokeAsync(_bet);
        }
    }

    private async Task ConfirmSurrender()
    {
        var confirm = await DialogService.ShowMessageBox("Conferma", "Vuoi davvero arrenderti e terminare la partita?", yesText: "Sì", noText: "No");

        if (confirm == true)
            await OnEnd.InvokeAsync(Player);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && _betField is not null)
            await _betField.SelectAsync();

        await base.OnAfterRenderAsync(firstRender);
    }
}